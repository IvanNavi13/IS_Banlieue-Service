/*-------------------- OBTENCIÃ“N DE DATOS DE PERSONAS --------------------*/
DELIMITER #
CREATE PROCEDURE infoCliente(IN corrcliente text)
BEGIN
	SELECT c.idPersona, c.idCli as idPartic, CONCAT(p.nombres, " ", p.apaterno, " ", p.amaterno) AS nombre, p.telefono, p.fechanac, p.correo, p.contrasena
	FROM Persona p, Cliente c
	WHERE 
	p.idPersona=c.idPersona AND 
	p.correo=corrcliente;
END #
DELIMITER ;

DELIMITER #
CREATE PROCEDURE infoUsuario(IN corrusuario text)
BEGIN
	SELECT u.idPersona, u.idUs as idPartic, CONCAT(p.nombres, " ", p.apaterno, " ", p.amaterno) AS nombre, p.telefono, p.fechanac, p.correo, p.contrasena
	FROM Persona p, Usuario u
	WHERE 
	p.idPersona=u.idPersona AND 
	p.correo=corrusuario;
END #
DELIMITER ;

DELIMITER #
CREATE PROCEDURE infoRepartidor(IN corrrepartidor text)
BEGIN
	SELECT r.idPersona, r.idRep as idPartic, v.idVe, r.CURP, CONCAT(p.nombres, " ", p.apaterno, " ", p.amaterno) AS nombre, p.telefono, p.fechanac, p.correo, p.contrasena, v.tipo AS vehiculo, v.placa
	FROM Persona p, Repartidor r, Vehiculo v
	WHERE 
	p.idPersona=r.idPersona AND 
	r.idRep=v.idRep AND 
	p.correo=corrrepartidor;
END #
DELIMITER ;

/*-------------------- ELIMINACIONES --------------------*/
DELIMITER #
CREATE PROCEDURE elimUsuario(IN idusr int, IN idper int)
BEGIN
	DELETE FROM Pedido WHERE idUs=idusr;
	DELETE FROM Usuario WHERE idUs=idusr;
	DELETE FROM Persona WHERE idPersona=idper;
END #
DELIMITER ;

DELIMITER #
CREATE PROCEDURE elimCliente(IN idclie int, IN idper int)
BEGIN
	DELETE FROM Establecimiento WHERE idCli=idclie;
	DELETE FROM Cliente WHERE idCli=idclie;
	DELETE FROM Persona WHERE idPersona=idper;
END #
DELIMITER ;

DELIMITER #
CREATE PROCEDURE elimRepartidor(IN idrepa int, IN idper int)
BEGIN
	DELETE FROM CuerpoPedido WHERE idRep=idrepa;
	DELETE FROM Vehiculo WHERE idRep=idrepa;
	DELETE FROM Repartidor WHERE idRep=idrepa;
	DELETE FROM Persona WHERE idPersona=idper;
END #
DELIMITER ;

/*-------------------- PEDIDOS DE UN REPARTIDOR --------------------*/
DELIMITER #
CREATE PROCEDURE pedidosTomadosPor(IN idrepa int)
BEGIN
	SELECT * FROM pedidosTomados WHERE idRep=idrepa;
END #
DELIMITER ;

DELIMITER #
CREATE PROCEDURE pedidosRealizadosPor(IN idrepa int)
BEGIN
	SELECT * FROM pedidosRealizados WHERE idRep=idrepa;
END #
DELIMITER ;

DELIMITER #
CREATE PROCEDURE pedido(IN idpedido int)
BEGIN
	SELECT * from cuerposDePedido WHERE idPed=idpedido;
END #
DELIMITER ;

DELIMITER #
CREATE PROCEDURE lugDePedido(IN idpedido int)
BEGIN
	SELECT * from lugarDePedido WHERE idPed=idpedido;
END #
DELIMITER ;

	


/*-------------------- VISTAS --------------------*/
CREATE VIEW pedidosDisponibles AS
	SELECT ped.idPed, CONCAT(p.nombres, " ", p.apaterno, " ", p.amaterno) AS persona, p.telefono, ped.direccion, ped.fecha, ped.hora 
	FROM Persona p, Pedido ped, Usuario u 
	WHERE 
	ped.idUs=u.idUs AND 
	u.idPersona=p.idPersona AND
	ped.idRep IS NULL AND 
	ped.hecho=0;

CREATE VIEW cuerposDePedido AS
	SELECT ped.idPed, ps.nombre AS prod_serv, ps.precio, cp.cantidad 
	FROM Establecimiento e, Producto_Servicio ps, Pedido ped, CuerpoPedido cp 
	WHERE 
	cp.idPed=ped.idPed AND 
	cp.idProdserv=ps.idProdserv AND 
	ps.idEst=e.idEst;

CREATE VIEW lugarDePedido AS
	SELECT DISTINCT ped.idPed, e.nombre AS lugar, e.direccion AS dirLugar, CONCAT(e.apertura, " - ", e.cierre) AS horarioLugar 
	FROM Establecimiento e, Producto_Servicio ps, Pedido ped, CuerpoPedido cp 
	WHERE 
	cp.idPed=ped.idPed AND 
	cp.idProdserv=ps.idProdserv AND 
	ps.idEst=e.idEst;

CREATE VIEW pedidosTomados AS
	SELECT ped.idRep, ped.idPed, CONCAT(p.nombres, " ", p.apaterno, " ", p.amaterno) AS persona, p.telefono, ped.direccion, ped.fecha, ped.hora 
	FROM Persona p, Pedido ped, Usuario u 
	WHERE 
	ped.idUs=u.idUs AND 
	u.idPersona=p.idPersona AND
	ped.idRep IS NOT NULL AND 
	ped.hecho=0;

CREATE VIEW pedidosRealizados AS
	SELECT ped.idRep, ped.idPed, CONCAT(p.nombres, " ", p.apaterno, " ", p.amaterno) AS persona, p.telefono, ped.direccion, ped.fecha, ped.hora 
	FROM Persona p, Pedido ped, Usuario u 
	WHERE 
	ped.idUs=u.idUs AND 
	u.idPersona=p.idPersona AND
	ped.idRep IS NOT NULL AND 
	ped.hecho=1;

